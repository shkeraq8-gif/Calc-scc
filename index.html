<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SSVC0059 Expert Pro</title>
    <style>
        :root { --blue: #007aff; --red: #ff3b30; --green: #34c759; --bg: #f2f2f7; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; padding: 10px; background: var(--bg); color: #1c1c1e; line-height: 1.4; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: auto; }
        
        .tabs { display: flex; background: #e3e3e8; padding: 3px; border-radius: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { flex: 1; border: none; padding: 8px 5px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; background: none; color: #8e8e93; white-space: nowrap; }
        .tab-btn.active { background: #fff; color: var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .section { display: none; }
        .section.active { display: block; }

        label { display: block; font-size: 10px; color: #8e8e93; margin: 12px 0 4px 5px; text-transform: uppercase; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; box-sizing: border-box; font-size: 16px; font-weight: 600; background: #fff; }
        
        .result-box { margin-top: 20px; background: var(--blue); color: #fff; padding: 15px; border-radius: 12px; text-align: center; }
        .res-val { font-size: 38px; font-weight: bold; display: block; margin: 5px 0; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f8fa; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; }
        .power-card { background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 12px; text-align: center; margin-top: 10px; }
        .p-val { font-size: 28px; color: var(--blue); font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'calcTab')">ОТБОР</button>
        <button class="tab-btn" onclick="openTab(event, 'testTab')">ЗАМЕР</button>
        <button class="tab-btn" onclick="openTab(event, 'powerTab')">МОЩНОСТЬ</button>
        <button class="tab-btn" onclick="openTab(event, 'tableTab')">ТАБЛИЦА</button>
    </div>

    <div id="calcTab" class="section active">
        <label>Пропускная (мл/сек)</label>
        <input type="number" id="cap" step="0.01" value="3.39" inputmode="decimal">
        <label>Ton - ОТКРЫТО (сек)</label>
        <input type="number" id="ton" step="0.1" value="0.7" inputmode="decimal">
        <label>Нужный отбор (мл/час)</label>
        <input type="number" id="flow" placeholder="1000" inputmode="numeric">
        <div id="resBox" class="result-box">
            <small>ПАРАМЕТР Tperiod:</small>
            <span id="tperiod" class="res-val">0</span>
            <small id="status">Введите данные</small>
        </div>
    </div>

    <div id="powerTab" class="section">
        <label>Номинал ТЭНа (Вт при 220В)</label>
        <input type="number" id="p_nom" placeholder="3000" value="3000" inputmode="numeric">
        
        <label>Текущее напряжение (Вольт)</label>
        <input type="number" id="v_now" placeholder="220" inputmode="numeric">

        <div class="power-card">
            <small style="color:#666">РЕАЛЬНАЯ МОЩНОСТЬ:</small>
            <div id="p_real" class="p-val">0 Вт</div>
            <div id="p_diff" style="font-size:12px; margin-top:5px; color:#888"></div>
        </div>
        
        <p style="font-size: 11px; color: #999; margin-top: 15px; text-align: center;">
            * Расчет по формуле: $P_{real} = P_{nom} \times (V_{now}^2 / 220^2)$
        </p>
    </div>

    <div id="testTab" class="section">
        <label>Собрано мл</label>
        <input type="number" id="test_ml" placeholder="89" inputmode="decimal">
        <label>За время (мин)</label>
        <input type="number" id="test_min" placeholder="30" inputmode="decimal">
        <div class="info-grid">
            <div>Ton: <b id="test_ton_val">0.7</b></div>
            <div>Tp: <b id="test_tp_val">48</b></div>
        </div>
        <div style="margin-top:15px; text-align:center; padding:15px; background:#f0f0f5; border-radius:12px;">
            <small>НОВЫЙ CAP (МЛ/СЕК):</small>
            <div id="new_cap_res" style="font-size:24px; font-weight:bold; color:var(--blue);">0.00</div>
        </div>
        <button style="width:100%; margin-top:10px; padding:12px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight:bold;" onclick="applyNewCap()">ПРИМЕНИТЬ</button>
    </div>

    <div id="tableTab" class="section">
        <div id="tableData"></div>
    </div>
</div>

<script>
    const el = (id) => document.getElementById(id);

    function openTab(evt, tabName) {
        let contents = document.getElementsByClassName("section");
        for (let i = 0; i < contents.length; i++) contents[i].classList.remove("active");
        let buttons = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < buttons.length; i++) buttons[i].classList.remove("active");
        el(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
        if(tabName === 'tableTab') updateTable();
    }

    // Расчет мощности
    const calcPower = () => {
        const pNom = parseFloat(el('p_nom').value) || 0;
        const vNow = parseFloat(el('v_now').value) || 0;
        if (pNom > 0 && vNow > 0) {
            const pReal = Math.round(pNom * (Math.pow(vNow, 2) / Math.pow(220, 2)));
            el('p_real').innerText = pReal + " Вт";
            const diff = pReal - pNom;
            el('p_diff').innerText = (diff >= 0 ? "+" : "") + diff + " Вт от номинала";
        }
    };
    el('p_nom').addEventListener('input', calcPower);
    el('v_now').addEventListener('input', calcPower);

    // Весь остальной функционал (ОТБОР, ЗАМЕР)
    const calculate = () => {
        const cap = parseFloat(el('cap').value) || 0;
        const ton = parseFloat(el('ton').value) || 0;
        const flow = parseFloat(el('flow').value) || 0;
        if (cap > 0 && ton > 0 && flow > 0) {
            let tp = Math.round((cap * ton * 3600) / flow);
            el('tperiod').innerText = tp > 999 ? "999" : tp;
            el('status').innerText = tp > 999 ? "Предел" : "Tperiod для контроллера";
            el('test_tp_val').innerText = tp;
        }
    };
    ['cap', 'ton', 'flow'].forEach(id => el(id).addEventListener('input', calculate));

    // Логика замера
    const calcCalib = () => {
        const ml = parseFloat(el('test_ml').value) || 0;
        const min = parseFloat(el('test_min').value) || 0;
        const ton = parseFloat(el('ton').value) || 0;
        const tp = parseFloat(el('test_tp_val').innerText) || 0;
        if (ml > 0 && min > 0 && tp > 0) {
            let flowH = (ml / min) * 60;
            let cap = (flowH / (ton / tp)) / 3600;
            el('new_cap_res').innerText = cap.toFixed(2);
        }
    };
    ['test_ml', 'test_min'].forEach(id => el(id).addEventListener('input', calcCalib));

    function applyNewCap() {
        el('cap').value = el('new_cap_res').innerText;
        alert("ОК! Параметр Cap обновлен.");
        calculate();
    }

    function updateTable() {
        const cap = parseFloat(el('cap').value) || 0;
        const ton = parseFloat(el('ton').value) || 0;
        let html = '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
        html += '<tr style="color:#888; border-bottom:1px solid #eee"><th>Tp</th><th>Отбор л/ч</th><th>Загрузка</th></tr>';
        [2, 5, 10, 20, 48, 100, 200].forEach(tp => {
            if (tp > ton) {
                let f = ((ton / tp) * cap * 3600 / 1000).toFixed(2);
                html += `<tr style="border-bottom:1px solid #eee; height:35px;"><td>${tp}с</td><td><b>${f} л</b></td><td>${Math.round(ton/tp*100)}%</td></tr>`;
            }
        });
        el('tableData').innerHTML = html + '</table>';
    }
</script>
</body>
</html>
